---
import Layout from '../../layouts/Layout.astro';
import { getGroupedAnnotations } from '../../db';

export function getStaticPaths() {
  const tree = getGroupedAnnotations();
  const paths = [];

  for (const author of Object.keys(tree)) {
    for (const book of Object.keys(tree[author])) {
      paths.push({
        params: { author, book },
        props: { annotations: tree[author][book] },
      });
    }
  }
  return paths;
}

const { author, book } = Astro.params;
const { annotations } = Astro.props;

const colorMap: Record<string, string> = {
  "3": "var(--highlight-green)",
  "2": "var(--highlight-blue)",
  "1": "var(--highlight-pink)",
  "0": "var(--highlight-yellow)",
};

const bgMap: Record<string, string> = {
  "3": "var(--highlight-green-bg)",
  "2": "var(--highlight-blue-bg)",
  "1": "var(--highlight-pink-bg)",
  "0": "var(--highlight-yellow-bg)",
};

// Sort by chapter? They are already sorted by BookTitle then DateCreated in SQL.
// Usually that's good enough.
---

<Layout title={`${book} | Annotations`}>
	<div style="margin-bottom: 2rem;">
		<a href={`/${author}/`} style="font-size: 0.9rem;">&larr; Back to {author}</a>
	</div>

	<h1 style="margin-bottom: 0.5rem;">{book}</h1>
    <p style="color: var(--text-secondary); margin-bottom: 3rem;">by {author}</p>

	<div class="annotations">
		{annotations.map((annot) => {
            // Fix: 0 is falsy, so we must check for null/undefined explicitly
            const colorKey = (annot.Color !== null && annot.Color !== undefined) ? String(annot.Color) : "none";
            
            const borderColor = colorMap[colorKey] || "var(--border-color)";
            const bgColor = bgMap[colorKey] || "rgba(255,255,255,0.02)";
            
            return (
                <div class="card" style={`border-left: 4px solid ${borderColor}; background: ${bgColor};`}>
                    {annot.Text && (
                        <blockquote style="border: none; background: transparent; padding: 0; margin-bottom: 1rem; font-style: italic;">
                            "{annot.Text.trim()}"
                        </blockquote>
                    )}
                    
                    {annot.Annotation && (
                         <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <strong style="color: var(--accent); display: block; margin-bottom: 0.25rem;">Note:</strong>
                            {annot.Annotation}
                        </div>
                    )}

                    <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.35rem;">
                            <span style="text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.7rem; font-weight: 700; opacity: 0.7;">
                                {annot.Type}
                            </span>
                            {annot.ChapterProgress > 0 && (
                                <div style="display: flex; align-items: center; gap: 0.5rem;" title={`Chapter Progress: ${Math.round(annot.ChapterProgress * 100)}%`}>
                                    <div style="width: 60px; height: 4px; background: rgba(127,127,127,0.2); border-radius: 2px; overflow: hidden;">
                                        <div style={`width: ${Math.round(annot.ChapterProgress * 100)}%; height: 100%; background: ${borderColor};`}></div>
                                    </div>
                                    <span style="font-size: 0.75rem; font-weight: 500; color: var(--text-secondary);">
                                        {Math.round(annot.ChapterProgress * 100)}%
                                    </span>
                                </div>
                            )}
                        </div>
                        <div style="text-align: right; display: flex; flex-direction: column; gap: 0.25rem;">
                            <div>Created: {(() => {
                                let d = annot.DateCreated;
                                if (!d.endsWith('Z')) d += 'Z';
                                return new Date(d).toLocaleString();
                            })()}</div>
                            {annot.DateModified && annot.DateModified !== annot.DateCreated && (
                                <div>Modified: {(() => {
                                    let d = annot.DateModified!;
                                    if (!d.endsWith('Z')) d += 'Z';
                                    return new Date(d).toLocaleString();
                                })()}</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        })}
	</div>
</Layout>
